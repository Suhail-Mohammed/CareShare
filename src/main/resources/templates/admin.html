<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel â€” Care & Share</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <style>
        :root {
          --primary-color: #28a745;
          --secondary-color: #218838;
          --accent-color: #71c787;
          --bg-light: #f8fafc;
          --text-dark: #1E293B;
          --card-shadow: rgba(0,0,0,0.05);
          --admin-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          --sidebar-width: 280px;
        }
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
          color: var(--text-dark);
          padding-top: 72px;
          min-height: 100vh;
        }
        .navbar-custom {
          background: #fff;
          box-shadow: 0 2px 20px rgba(0,0,0,0.1);
          position: fixed;
          width: 100%;
          z-index: 1050;
          backdrop-filter: blur(10px);
        }
        .navbar-brand {
          font-weight: 700;
          color: var(--primary-color);
          font-size: 1.6rem;
          display: flex;
          align-items: center;
        }
        .nav-link {
          color: var(--text-dark) !important;
          font-weight: 500;
          margin-left: 1rem;
          transition: all 0.3s ease;
          border-radius: 8px;
          padding: 8px 16px !important;
        }
        .nav-link:hover {
          color: var(--primary-color) !important;
          background: rgba(40, 167, 69, 0.1);
          transform: translateY(-1px);
        }
        .nav-link.active {
          color: var(--primary-color) !important;
          font-weight: 600;
          background: rgba(40, 167, 69, 0.15);
          box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
        }

        /* Admin Header */
        .admin-header {
          background: var(--admin-gradient);
          color: white;
          padding: 80px 0 60px;
          margin-bottom: 40px;
          position: relative;
          overflow: hidden;
        }
        .admin-header::before {
          content: "";
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="%23ffffff" opacity="0.1"><polygon points="1000,100 1000,0 0,100"/></svg>');
          background-size: cover;
        }
        .admin-header h1 {
          font-weight: 800;
          font-size: 3.5rem;
          margin-bottom: 1rem;
          text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .admin-header .lead {
          font-size: 1.3rem;
          opacity: 0.9;
          font-weight: 300;
        }

        /* Modern Stats Cards */
        .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 25px;
          margin-bottom: 40px;
        }
        .stat-card {
          background: white;
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.08);
          transition: all 0.3s ease;
          border: 1px solid rgba(255,255,255,0.2);
          backdrop-filter: blur(10px);
          position: relative;
          overflow: hidden;
        }
        .stat-card::before {
          content: "";
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: var(--admin-gradient);
        }
        .stat-card:hover {
          transform: translateY(-8px);
          box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .stat-icon {
          width: 70px;
          height: 70px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 20px;
          font-size: 2rem;
          background: var(--admin-gradient);
          color: white;
          box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        .stat-number {
          font-size: 2.8rem;
          font-weight: 800;
          color: var(--text-dark);
          margin-bottom: 8px;
          line-height: 1;
        }
        .stat-label {
          color: #6c757d;
          font-size: 1.1rem;
          font-weight: 500;
        }
        .stat-trend {
          display: inline-flex;
          align-items: center;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 0.85rem;
          font-weight: 600;
          margin-top: 10px;
        }
        .trend-up {
          background: rgba(40, 167, 69, 0.1);
          color: #28a745;
        }
        .trend-down {
          background: rgba(220, 53, 69, 0.1);
          color: #dc3545;
        }

        /* Modern Admin Sections */
        .admin-section {
          background: white;
          border-radius: 20px;
          padding: 35px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.08);
          margin-bottom: 30px;
          border: 1px solid rgba(255,255,255,0.2);
          backdrop-filter: blur(10px);
        }
        .section-header {
          display: flex;
          justify-content: between;
          align-items: center;
          margin-bottom: 30px;
          padding-bottom: 20px;
          border-bottom: 2px solid #f8f9fa;
        }
        .section-header h3 {
          font-weight: 700;
          color: var(--text-dark);
          margin: 0;
          display: flex;
          align-items: center;
          gap: 12px;
        }
        .section-header h3 i {
          color: var(--primary-color);
        }

        /* Modern Table */
        .user-table {
          width: 100%;
          border-collapse: separate;
          border-spacing: 0;
          border-radius: 15px;
          overflow: hidden;
          box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .user-table thead {
          background: var(--admin-gradient);
        }
        .user-table th {
          padding: 20px 15px;
          text-align: left;
          font-weight: 600;
          color: white;
          font-size: 0.9rem;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          border: none;
        }
        .user-table td {
          padding: 18px 15px;
          border-bottom: 1px solid #f8f9fa;
          background: white;
          transition: all 0.3s ease;
        }
        .user-table tbody tr {
          transition: all 0.3s ease;
        }
        .user-table tbody tr:hover {
          transform: translateX(5px);
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .user-table tbody tr:hover td {
          background: #f8f9fa;
        }

        /* Badges */
        .badge-admin {
          background: linear-gradient(135deg, #dc3545, #c82333);
          color: white;
          padding: 8px 16px;
          border-radius: 20px;
          font-size: 0.8rem;
          font-weight: 600;
          box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        .badge-user {
          background: linear-gradient(135deg, #28a745, #218838);
          color: white;
          padding: 8px 16px;
          border-radius: 20px;
          font-size: 0.8rem;
          font-weight: 600;
          box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        /* Buttons */
        .btn-modern {
          padding: 10px 20px;
          border-radius: 12px;
          font-weight: 600;
          border: none;
          transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-modern:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .btn-modern-primary {
          background: linear-gradient(135deg, #28a745, #218838);
          color: white;
        }
        .btn-modern-warning {
          background: linear-gradient(135deg, #ffc107, #e0a800);
          color: white;
        }
        .btn-modern-danger {
          background: linear-gradient(135deg, #dc3545, #c82333);
          color: white;
        }
        .btn-modern-secondary {
          background: linear-gradient(135deg, #6c757d, #5a6268);
          color: white;
        }

        /* Quick Actions */
        .quick-actions-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-top: 30px;
        }
        .action-card {
          background: white;
          border-radius: 15px;
          padding: 25px;
          text-align: center;
          transition: all 0.3s ease;
          border: 1px solid #f8f9fa;
          box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .action-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 15px 30px rgba(0,0,0,0.15);
          border-color: var(--primary-color);
        }
        .action-icon {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: var(--admin-gradient);
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto 15px;
          font-size: 1.5rem;
          color: white;
        }
        .action-title {
          font-weight: 600;
          margin-bottom: 8px;
          color: var(--text-dark);
        }
        .action-desc {
          color: #6c757d;
          font-size: 0.9rem;
        }

        /* System Info Cards */
        .info-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-top: 20px;
        }
        .info-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 25px;
          border-radius: 15px;
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .info-card h5 {
          margin-bottom: 15px;
          opacity: 0.9;
        }
        .info-card .value {
          font-size: 2rem;
          font-weight: 700;
          margin-bottom: 5px;
        }
        .info-card .label {
          opacity: 0.8;
          font-size: 0.9rem;
        }

        /* Add to your existing CSS */
        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .product-image:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
        }

        .image-placeholder {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 0.7rem;
            border: 2px dashed #dee2e6;
            text-align: center;
            padding: 5px;
        }

        /* Footer */
        .amazon-footer {
          background-color: #2d3748;
          color: white;
          padding: 40px 0;
        }
        .amazon-footer h5 {
          margin-bottom: 20px;
        }
        .amazon-footer ul {
          list-style: none;
          padding: 0;
        }
        .amazon-footer ul li {
          margin-bottom: 8px;
        }
        .amazon-footer ul li a {
          color: white;
          text-decoration: none;
        }
        .amazon-footer ul li a:hover {
          text-decoration: underline;
        }
        footer {
          background: var(--primary-color);
          color: white;
          padding: 25px 0;
        }
        footer a {
          color: white;
          margin: 0 10px;
          font-size: 1.2rem;
        }
        footer a:hover {
          color: var(--secondary-color);
          text-decoration: none;
        }
        footer .social-icons {
          margin-top: 10px;
        }

        /* Loading Animation */
        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }
        .loading {
          animation: pulse 1.5s ease-in-out infinite;
        }

        /* Debug Button */
        .debug-btn {
          position: fixed;
          top: 100px;
          right: 20px;
          z-index: 9999;
        }

        /* Responsive */
        @media (max-width: 768px) {
          .admin-header h1 {
            font-size: 2.5rem;
          }
          .stats-grid {
            grid-template-columns: 1fr;
          }
          .quick-actions-grid {
            grid-template-columns: 1fr;
          }
          .debug-btn {
            top: 80px;
            right: 10px;
          }
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light navbar-custom fixed-top shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="/">
            <img src="/images/logo.png" alt="Care & Share" style="height: 40px; width: auto; margin-right: 10px;">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
                <a class="nav-link active" href="/admin"><i class="fa-solid fa-shield-halved"></i> Admin Panel</a>

                <!-- User Dropdown -->
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa-solid fa-user"></i>
                        <span id="userName" th:text="${user?.firstName}">Admin</span>
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="/dashboard">
                            <i class="fa-solid fa-user me-2"></i>My Dashboard
                        </a></li>
                        <li><a class="dropdown-item" href="/admin">
                            <i class="fa-solid fa-shield-halved me-2"></i>Admin Panel
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" onclick="logout()">
                            <i class="fa-solid fa-right-from-bracket me-2"></i>Logout
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Admin Header -->
<div class="admin-header">
    <div class="container text-center">
        <h1><i class="fa-solid fa-shield-halved me-3"></i>Admin Dashboard</h1>
        <p class="lead">Complete control over your platform with advanced management tools</p>
    </div>
</div>

<!-- Admin Content -->
<div class="container">
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fa-solid fa-users"></i>
            </div>
            <div class="stat-number" id="totalUsers">0</div>
            <div class="stat-label">Total Users</div>
            <div class="stat-trend trend-up">
                <i class="fa-solid fa-arrow-up me-1"></i> 12% growth
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fa-solid fa-user-shield"></i>
            </div>
            <div class="stat-number" id="adminUsers">0</div>
            <div class="stat-label">Admin Users</div>
            <div class="stat-trend trend-up">
                <i class="fa-solid fa-plus me-1"></i> Active
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fa-solid fa-user"></i>
            </div>
            <div class="stat-number" id="regularUsers">0</div>
            <div class="stat-label">Regular Users</div>
            <div class="stat-trend trend-up">
                <i class="fa-solid fa-arrow-up me-1"></i> 8% growth
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fa-solid fa-boxes"></i>
            </div>
            <div class="stat-number" id="pendingProductsCount">0</div>
            <div class="stat-label">Pending Products</div>
            <div class="stat-trend trend-up">
                <i class="fa-solid fa-clock me-1"></i> Waiting
            </div>
        </div>
    </div>

    <!-- Users Management Section -->
    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-user-gear"></i> User Management</h3>
            <div>
                <button class="btn btn-modern btn-modern-primary" onclick="refreshUsers()">
                    <i class="fa-solid fa-refresh me-2"></i>Refresh Data
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="user-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>User Information</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="usersTableBody">
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <div class="spinner-border text-primary loading" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading user data...</p>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Product Management Section -->
    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-boxes"></i> Product Management</h3>
            <div>
                <button class="btn btn-modern btn-modern-primary" onclick="refreshUsers()">
                    <i class="fa-solid fa-refresh me-2"></i>Refresh Products
                </button>
                <button class="btn btn-modern btn-modern-warning ms-2" onclick="loadPendingProducts()">
                    <i class="fa-solid fa-sync me-2"></i>Load Products
                </button>
            </div>
        </div>

        <!-- Product Stats -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                    <div class="stat-number" id="pendingProductsCount2">0</div>
                    <div class="stat-label">Pending Products</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <div class="stat-number" id="approvedProductsCount">0</div>
                    <div class="stat-label">Approved Products</div>
                </div>
            </div>
        </div>

        <!-- Pending Products Table -->
        <div class="table-responsive">
            <table class="user-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Product Info</th>
                    <th>User</th>
                    <th>Type</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="pendingProductsTableBody">
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <div class="spinner-border text-primary loading" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading pending products...</p>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-bolt"></i> Quick Actions</h3>
        </div>
        <div class="quick-actions-grid">
            <div class="action-card" onclick="refreshUsers()">
                <div class="action-icon">
                    <i class="fa-solid fa-refresh"></i>
                </div>
                <div class="action-title">Refresh Data</div>
                <div class="action-desc">Update all statistics and user information</div>
            </div>
            <div class="action-card" onclick="exportData()">
                <div class="action-icon">
                    <i class="fa-solid fa-download"></i>
                </div>
                <div class="action-title">Export Data</div>
                <div class="action-desc">Download user reports and analytics</div>
            </div>
            <div class="action-card" onclick="showSystemSettings()">
                <div class="action-icon">
                    <i class="fa-solid fa-cog"></i>
                </div>
                <div class="action-title">System Settings</div>
                <div class="action-desc">Configure platform preferences</div>
            </div>
            <div class="action-card" onclick="showBackup()">
                <div class="action-icon">
                    <i class="fa-solid fa-database"></i>
                </div>
                <div class="action-title">Backup Data</div>
                <div class="action-desc">Create system backup</div>
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-info-circle"></i> System Overview</h3>
        </div>
        <div class="info-grid">
            <div class="info-card">
                <h5><i class="fa-solid fa-server me-2"></i>Platform Status</h5>
                <div class="value">Operational</div>
                <div class="label">All systems normal</div>
            </div>
            <div class="info-card">
                <h5><i class="fa-solid fa-shield-alt me-2"></i>Security Level</h5>
                <div class="value">High</div>
                <div class="label">Protected & Secure</div>
            </div>
            <div class="info-card">
                <h5><i class="fa-solid fa-clock me-2"></i>Last Updated</h5>
                <div class="value" id="lastUpdated">Just now</div>
                <div class="label">Real-time data</div>
            </div>
            <div class="info-card">
                <h5><i class="fa-solid fa-code-branch me-2"></i>Version</h5>
                <div class="value">v2.1.0</div>
                <div class="label">Latest release</div>
            </div>
        </div>
    </div>
</div>

<!-- Debug Button -->
<button class="btn btn-warning debug-btn" onclick="debugAdmin()">
    <i class="fa-solid fa-bug me-1"></i> Debug
</button>

<!-- Amazon-style footer -->
<section class="amazon-footer">
    <div class="container">
        <div class="row text-start">
            <div class="col-md-3 mb-3">
                <h5>Admin Links</h5>
                <ul>
                    <li><a href="/admin">Admin Panel</a></li>
                    <li><a href="/dashboard">User Dashboard</a></li>
                    <li><a href="/">Homepage</a></li>
                </ul>
            </div>
            <div class="col-md-3 mb-3">
                <h5>Platform</h5>
                <ul>
                    <li><a href="#">System Status</a></li>
                    <li><a href="#">User Reports</a></li>
                    <li><a href="#">Activity Logs</a></li>
                </ul>
            </div>
            <div class="col-md-3 mb-3">
                <h5>Management</h5>
                <ul>
                    <li><a href="#" onclick="refreshUsers()">Refresh Users</a></li>
                    <li><a href="#">Backup Data</a></li>
                    <li><a href="#">System Settings</a></li>
                </ul>
            </div>
            <div class="col-md-3 mb-3">
                <h5>Support</h5>
                <ul>
                    <li><a href="#">Admin Guide</a></li>
                    <li><a href="#">Contact Developers</a></li>
                    <li><a href="#">Bug Reports</a></li>
                </ul>
            </div>
        </div>
    </div>
</section>

<!-- Original Footer -->
<footer class="text-center">
    <div class="container">
        <p>Â© 2025 Care & Share. All rights reserved. | Admin Panel v2.1.0</p>
        <div class="social-icons">
            <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
            <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
        </div>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    const token = localStorage.getItem('jwtToken');

    // Debug function
    function debugAdmin() {
        console.log('=== ADMIN PANEL DEBUG INFO ===');
        console.log('JWT Token:', token ? 'Present' : 'Missing');
        console.log('Table body exists:', !!document.getElementById('pendingProductsTableBody'));
        console.log('Current user stats:', {
            totalUsers: document.getElementById('totalUsers').textContent,
            pendingProducts: document.getElementById('pendingProductsCount').textContent
        });

        // Test API endpoints
        loadPendingProducts();
        loadProductStats();
    }

    // Check if user is admin
    function checkAdminAccess() {
        if (!token) {
            window.location.href = '/login';
            return;
        }

        fetch('/api/admin/stats', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Not an admin');
            }
            return response.json();
        })
        .catch(error => {
            console.error('Admin access denied:', error);
            alert('Access denied. Admin privileges required.');
            window.location.href = '/dashboard';
        });
    }

    // Load admin statistics
    function loadStats() {
        fetch('/api/admin/stats', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalUsers').textContent = data.totalUsers || 0;
            document.getElementById('adminUsers').textContent = data.adminUsers || 0;
            document.getElementById('regularUsers').textContent = data.regularUsers || 0;
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
    }

    // Load users list
    function loadUsers() {
        fetch('/api/admin/users', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(users => {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="fa-solid fa-users-slash me-2 fa-2x"></i>
                            <p class="mt-3">No users found in the system</p>
                        </td>
                    </tr>
                `;
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>#${user.id}</strong></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                <i class="fa-solid fa-user text-white"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${user.firstName} ${user.lastName}</div>
                                <small class="text-muted">User ID: ${user.id}</small>
                            </div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="${user.admin ? 'badge-admin' : 'badge-user'}">
                            <i class="fa-solid ${user.admin ? 'fa-shield-halved' : 'fa-user'} me-1"></i>
                            ${user.admin ? 'ADMIN' : 'USER'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm ${user.admin ? 'btn-modern-warning' : 'btn-modern-primary'}"
                                    onclick="toggleAdmin(${user.id}, ${!user.admin})">
                                <i class="fa-solid ${user.admin ? 'fa-user-slash' : 'fa-user-shield'} me-1"></i>
                                ${user.admin ? 'Remove Admin' : 'Make Admin'}
                            </button>
                            <button class="btn btn-sm btn-modern-danger ms-1"
                                    onclick="deleteUser(${user.id})"
                                    ${user.admin ? 'disabled' : ''}>
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error loading users:', error);
            document.getElementById('usersTableBody').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-5 text-danger">
                        <i class="fa-solid fa-exclamation-triangle me-2 fa-2x"></i>
                        <p class="mt-3">Error loading user data</p>
                        <small>Please try refreshing the page</small>
                    </td>
                </tr>
            `;
        });
    }

    // Product Management Functions
    function loadProductStats() {
        console.log('Loading product stats...');

        fetch('/api/admin/products/stats', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Stats response status:', response.status);
            if (!response.ok) {
                throw new Error('Failed to fetch product stats: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Product stats received:', data);
            document.getElementById('pendingProductsCount').textContent = data.pendingProducts || 0;
            document.getElementById('pendingProductsCount2').textContent = data.pendingProducts || 0;
            document.getElementById('approvedProductsCount').textContent = data.approvedProducts || 0;
        })
        .catch(error => {
            console.error('Error loading product stats:', error);
            showNotification('Error loading product stats', 'error');
        });
    }

    function loadPendingProducts() {
        console.log('Loading pending products...');

        fetch('/api/admin/products/pending', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Pending products response status:', response.status);
            if (!response.ok) {
                throw new Error('Failed to fetch pending products: ' + response.status);
            }
            return response.json();
        })
        .then(products => {
            console.log('Pending products data received:', products);
            displayPendingProducts(products);
        })
        .catch(error => {
            console.error('Error loading pending products:', error);
            showNotification('Error loading pending products', 'error');
            displayPendingProducts([]);
        });
    }

    function displayPendingProducts(products) {
        const tbody = document.getElementById('pendingProductsTableBody');
        if (!tbody) {
            console.error('Table body element not found!');
            return;
        }

        console.log('Displaying products:', products);

        if (!products || products.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5 text-muted">
                        <i class="fa-solid fa-check-circle me-2 fa-2x"></i>
                        <p class="mt-3">No pending products for approval</p>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        products.forEach(product => {
            console.log('Processing product:', product);

            // Handle user data safely
            const userFirstName = product.userFirstName || 'Unknown';
            const userLastName = product.userLastName || 'User';
            const userEmail = product.userEmail || 'No email';

            html += `
                <tr>
                    <td><strong>#${product.id}</strong></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${product.imagePath || '/images/placeholder.jpg'}"
                                 alt="${product.name}"
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;"
                                 class="me-3"
                                 onerror="this.src='/images/placeholder.jpg'">
                            <div>
                                <div class="fw-bold">${product.name}</div>
                                <small class="text-muted">${product.category} â€¢ ${(product.description || '').substring(0, 50)}...</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>${userFirstName} ${userLastName}</div>
                        <small class="text-muted">${userEmail}</small>
                    </td>
                    <td>
                        <span class="badge ${getProductTypeBadgeClass(product.type)}">
                            ${product.type}
                        </span>
                    </td>
                    <td>â‚¹${product.price}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-modern-primary" onclick="approveProduct(${product.id})">
                                <i class="fa-solid fa-check me-1"></i>Approve
                            </button>
                            <button class="btn btn-sm btn-modern-danger ms-1" onclick="showRejectModal(${product.id})">
                                <i class="fa-solid fa-times me-1"></i>Reject
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
        console.log('Products displayed in table');
    }

    function getProductTypeBadgeClass(type) {
        switch(type) {
            case 'Donate': return 'bg-success';
            case 'Exchange': return 'bg-warning';
            case 'Resell': return 'bg-info';
            default: return 'bg-secondary';
        }
    }

    function approveProduct(productId) {
        if (!confirm('Are you sure you want to approve this product?')) {
            return;
        }

        console.log('Approving product:', productId);

        fetch(`/api/admin/products/${productId}/approve`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to approve product: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Product approved:', data);
            showNotification('Product approved successfully', 'success');
            loadPendingProducts();
            loadProductStats();
        })
        .catch(error => {
            console.error('Error approving product:', error);
            showNotification('Error approving product', 'error');
        });
    }

    function showRejectModal(productId) {
        const reason = prompt('Please enter rejection reason:');
        if (reason !== null && reason.trim() !== '') {
            rejectProduct(productId, reason.trim());
        } else if (reason !== null) {
            showNotification('Rejection reason cannot be empty', 'error');
        }
    }

    function rejectProduct(productId, rejectionReason) {
        console.log('Rejecting product:', productId);

        fetch(`/api/admin/products/${productId}/reject`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rejectionReason })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to reject product: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Product rejected:', data);
            showNotification('Product rejected successfully', 'success');
            loadPendingProducts();
            loadProductStats();
        })
        .catch(error => {
            console.error('Error rejecting product:', error);
            showNotification('Error rejecting product', 'error');
        });
    }

    // Toggle admin role
    function toggleAdmin(userId, makeAdmin) {
        if (!confirm(`Are you sure you want to ${makeAdmin ? 'make this user an admin' : 'remove admin rights from this user'}?`)) {
            return;
        }

        fetch(`/api/admin/users/${userId}/role`, {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ isAdmin: makeAdmin })
        })
        .then(response => response.json())
        .then(data => {
            showNotification(data.message || 'User role updated successfully', 'success');
            refreshUsers();
        })
        .catch(error => {
            console.error('Error updating user role:', error);
            showNotification('Error updating user role', 'error');
        });
    }

    // Delete user
    function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            return;
        }

        fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            showNotification(data.message || 'User deleted successfully', 'success');
            refreshUsers();
        })
        .catch(error => {
            console.error('Error deleting user:', error);
            showNotification('Error deleting user', 'error');
        });
    }

    // Refresh all data
    function refreshUsers() {
        console.log('Refreshing all data...');
        loadStats();
        loadUsers();
        loadProductStats();
        loadPendingProducts();
        document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        showNotification('Data refreshed successfully', 'success');
    }

    // Quick action functions
    function exportData() {
        showNotification('Export feature coming soon!', 'info');
    }

    function showSystemSettings() {
        showNotification('System settings panel coming soon!', 'info');
    }

    function showBackup() {
        showNotification('Backup feature coming soon!', 'info');
    }

    // Notification system
    function showNotification(message, type = 'info') {
        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'error' ? 'alert-danger' : 'alert-info';

        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 100px; right: 20px; z-index: 1060; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // Logout function
    function logout() {
        fetch('/api/auth/logout', {
            method: 'POST',
            credentials: 'include'
        })
        .then(() => {
            localStorage.removeItem('jwtToken');
            window.location.href = '/';
        })
        .catch(error => {
            console.error('Logout error:', error);
            localStorage.removeItem('jwtToken');
            window.location.href = '/';
        });
    }

    // Initialize admin panel
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin panel DOM loaded');
        checkAdminAccess();
        refreshUsers();
        document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
    });
</script>
</body>
</html>